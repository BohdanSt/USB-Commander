#pragma once
#include "SettingsForm1.h"
#include "AboutForm1.h"
#include "windows.h"
#include "USB_Class.h"
#include <vector>
#include <string> 
#include "SettingsForm1.h"

namespace Kursova {

	using namespace System;
	using namespace System::ComponentModel;
	using namespace System::Collections;
	using namespace System::Collections::Generic;
	using namespace System::Windows::Forms;
	using namespace System::Data;
	using namespace System::Drawing;
	using namespace System::Diagnostics;
	using namespace System::IO;
	using namespace Microsoft::Win32;

	/// <summary>
	/// Сводка для MyForm
	/// </summary>
	
	public ref class MyForm : public System::Windows::Forms::Form
	{
	public:
		
		MyForm(void)
		{
			InitializeComponent();
			//
			//TODO: добавьте код конструктора
			//
		}

	protected:
		/// <summary>
		/// Освободить все используемые ресурсы.
		/// </summary>
		~MyForm()
		{
			if (components)
			{
				delete components;
			}
		}
	private: System::Windows::Forms::ListView^  listView1;
	private: System::Windows::Forms::MenuStrip^  menuStrip1;
	private: System::Windows::Forms::StatusStrip^  statusStrip1;
	private: System::Windows::Forms::Button^  button1;
	private: System::Windows::Forms::Button^  button2;
	private: System::Windows::Forms::ToolStripMenuItem^  файлToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  відкритиToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  зберегтиToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  налаштуванняToolStripMenuItem;

	private: System::Windows::Forms::ToolStripMenuItem^  вихідToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  функціїToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  перегToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  витягнутToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  інформаціяToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  проПрограмуToolStripMenuItem;
	private: System::Windows::Forms::ToolStripMenuItem^  допомогаToolStripMenuItem;
	private: System::Windows::Forms::ToolStrip^  toolStrip1;
	private: System::Windows::Forms::ToolStripProgressBar^  toolStripProgressBar1;
	private: System::Windows::Forms::ToolStripStatusLabel^  toolStripStatusLabel1;
	private: System::Windows::Forms::ToolStripButton^  toolStripButton1;
	private: System::Windows::Forms::ToolStripButton^  toolStripButton2;

	private: System::Windows::Forms::ToolStripButton^  toolStripButton4;
	private: System::Windows::Forms::ToolStripButton^  toolStripButton5;
	private: System::Windows::Forms::ToolStripButton^  toolStripButton6;
	private: System::Windows::Forms::ToolStripButton^  toolStripButton7;
	private: System::Windows::Forms::ToolStripButton^  toolStripButton8;
	private: System::Windows::Forms::ToolStripSeparator^  toolStripSeparator1;
	private: System::Windows::Forms::ToolStripSeparator^  toolStripSeparator2;

	private: 

	private: System::Windows::Forms::OpenFileDialog^  openFileDialog1;
	public: 
	private: System::Windows::Forms::SaveFileDialog^  saveFileDialog1;
	private: System::Windows::Forms::Timer^  timer1;
	private: System::Windows::Forms::NotifyIcon^  notifyIcon1;
	private: System::Windows::Forms::ContextMenuStrip^  contextMenuStrip1;
	private: System::Windows::Forms::ToolStripMenuItem^  розгорнутиToolStripMenuItem;

	private: System::Windows::Forms::ToolStripMenuItem^  вихідToolStripMenuItem2;
	private: System::ComponentModel::IContainer^  components;
	private: System::Windows::Forms::Timer^  timer2;

	public: Dictionary <DWORD , USB_Device^> ^USB_List;
	public: Dictionary <DWORD, CHAR> ^UpdatingList;
	private: System::Windows::Forms::ColumnHeader^  columnHeader3;
	public: 
	private: System::Windows::Forms::ColumnHeader^  columnHeader4;
	private: System::Windows::Forms::ColumnHeader^  columnHeader5;
	private: System::Windows::Forms::ColumnHeader^  columnHeader6;
	private: System::Windows::Forms::ColumnHeader^  columnHeader1;
	private: System::Windows::Forms::ColumnHeader^  columnHeader2;
	public: BOOL ISUpdating;

	protected: 

	private:
		/// <summary>
		/// Требуется переменная конструктора.
		/// </summary>


#pragma region Windows Form Designer generated code
		/// <summary>
		/// Обязательный метод для поддержки конструктора - не изменяйте
		/// содержимое данного метода при помощи редактора кода.
		/// </summary>
		void InitializeComponent(void)
		{
			this->components = (gcnew System::ComponentModel::Container());
			System::ComponentModel::ComponentResourceManager^  resources = (gcnew System::ComponentModel::ComponentResourceManager(MyForm::typeid));
			this->listView1 = (gcnew System::Windows::Forms::ListView());
			this->columnHeader1 = (gcnew System::Windows::Forms::ColumnHeader(L"(none)"));
			this->columnHeader2 = (gcnew System::Windows::Forms::ColumnHeader(L"(none)"));
			this->columnHeader3 = (gcnew System::Windows::Forms::ColumnHeader());
			this->columnHeader4 = (gcnew System::Windows::Forms::ColumnHeader());
			this->columnHeader5 = (gcnew System::Windows::Forms::ColumnHeader());
			this->columnHeader6 = (gcnew System::Windows::Forms::ColumnHeader());
			this->menuStrip1 = (gcnew System::Windows::Forms::MenuStrip());
			this->файлToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->відкритиToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->зберегтиToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->toolStripSeparator2 = (gcnew System::Windows::Forms::ToolStripSeparator());
			this->налаштуванняToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->toolStripSeparator1 = (gcnew System::Windows::Forms::ToolStripSeparator());
			this->вихідToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->функціїToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->перегToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->витягнутToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->інформаціяToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->проПрограмуToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->допомогаToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->statusStrip1 = (gcnew System::Windows::Forms::StatusStrip());
			this->toolStripProgressBar1 = (gcnew System::Windows::Forms::ToolStripProgressBar());
			this->toolStripStatusLabel1 = (gcnew System::Windows::Forms::ToolStripStatusLabel());
			this->button1 = (gcnew System::Windows::Forms::Button());
			this->button2 = (gcnew System::Windows::Forms::Button());
			this->toolStrip1 = (gcnew System::Windows::Forms::ToolStrip());
			this->toolStripButton1 = (gcnew System::Windows::Forms::ToolStripButton());
			this->toolStripButton2 = (gcnew System::Windows::Forms::ToolStripButton());
			this->toolStripButton4 = (gcnew System::Windows::Forms::ToolStripButton());
			this->toolStripButton5 = (gcnew System::Windows::Forms::ToolStripButton());
			this->toolStripButton6 = (gcnew System::Windows::Forms::ToolStripButton());
			this->toolStripButton7 = (gcnew System::Windows::Forms::ToolStripButton());
			this->toolStripButton8 = (gcnew System::Windows::Forms::ToolStripButton());
			this->openFileDialog1 = (gcnew System::Windows::Forms::OpenFileDialog());
			this->saveFileDialog1 = (gcnew System::Windows::Forms::SaveFileDialog());
			this->timer1 = (gcnew System::Windows::Forms::Timer(this->components));
			this->notifyIcon1 = (gcnew System::Windows::Forms::NotifyIcon(this->components));
			this->contextMenuStrip1 = (gcnew System::Windows::Forms::ContextMenuStrip(this->components));
			this->розгорнутиToolStripMenuItem = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->вихідToolStripMenuItem2 = (gcnew System::Windows::Forms::ToolStripMenuItem());
			this->timer2 = (gcnew System::Windows::Forms::Timer(this->components));
			this->menuStrip1->SuspendLayout();
			this->statusStrip1->SuspendLayout();
			this->toolStrip1->SuspendLayout();
			this->contextMenuStrip1->SuspendLayout();
			this->SuspendLayout();
			// 
			// listView1
			// 
			this->listView1->Anchor = static_cast<System::Windows::Forms::AnchorStyles>((((System::Windows::Forms::AnchorStyles::Top | System::Windows::Forms::AnchorStyles::Bottom) 
				| System::Windows::Forms::AnchorStyles::Left) 
				| System::Windows::Forms::AnchorStyles::Right));
			this->listView1->BackColor = System::Drawing::SystemColors::Window;
			this->listView1->Columns->AddRange(gcnew cli::array< System::Windows::Forms::ColumnHeader^  >(6) {this->columnHeader1, this->columnHeader2, 
				this->columnHeader3, this->columnHeader4, this->columnHeader5, this->columnHeader6});
			this->listView1->ForeColor = System::Drawing::SystemColors::WindowText;
			this->listView1->FullRowSelect = true;
			this->listView1->GridLines = true;
			this->listView1->HeaderStyle = System::Windows::Forms::ColumnHeaderStyle::Nonclickable;
			this->listView1->Location = System::Drawing::Point(13, 58);
			this->listView1->Name = L"listView1";
			this->listView1->Size = System::Drawing::Size(260, 133);
			this->listView1->TabIndex = 0;
			this->listView1->UseCompatibleStateImageBehavior = false;
			this->listView1->View = System::Windows::Forms::View::Details;
			// 
			// columnHeader1
			// 
			this->columnHeader1->Text = L"Назва пристрою";
			this->columnHeader1->Width = 128;
			// 
			// columnHeader2
			// 
			this->columnHeader2->Text = L"Місткість";
			this->columnHeader2->Width = 128;
			// 
			// columnHeader3
			// 
			this->columnHeader3->Text = L"Вільно на диску";
			this->columnHeader3->Width = 0;
			// 
			// columnHeader4
			// 
			this->columnHeader4->Text = L"Файлова система";
			this->columnHeader4->Width = 0;
			// 
			// columnHeader5
			// 
			this->columnHeader5->Text = L"Серійний номер";
			this->columnHeader5->Width = 0;
			// 
			// columnHeader6
			// 
			this->columnHeader6->Text = L"Гаряча клавіша для витягнення";
			this->columnHeader6->Width = 0;
			// 
			// menuStrip1
			// 
			this->menuStrip1->Items->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(3) {this->файлToolStripMenuItem, 
				this->функціїToolStripMenuItem, this->інформаціяToolStripMenuItem});
			this->menuStrip1->Location = System::Drawing::Point(0, 0);
			this->menuStrip1->Name = L"menuStrip1";
			this->menuStrip1->Size = System::Drawing::Size(284, 24);
			this->menuStrip1->TabIndex = 1;
			this->menuStrip1->Text = L"menuStrip1";
			// 
			// файлToolStripMenuItem
			// 
			this->файлToolStripMenuItem->DropDownItems->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(6) {this->відкритиToolStripMenuItem, 
				this->зберегтиToolStripMenuItem, this->toolStripSeparator2, this->налаштуванняToolStripMenuItem, this->toolStripSeparator1, this->вихідToolStripMenuItem});
			this->файлToolStripMenuItem->Name = L"файлToolStripMenuItem";
			this->файлToolStripMenuItem->Size = System::Drawing::Size(48, 20);
			this->файлToolStripMenuItem->Text = L"Файл";
			// 
			// відкритиToolStripMenuItem
			// 
			this->відкритиToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"відкритиToolStripMenuItem.Image")));
			this->відкритиToolStripMenuItem->Name = L"відкритиToolStripMenuItem";
			this->відкритиToolStripMenuItem->Size = System::Drawing::Size(156, 22);
			this->відкритиToolStripMenuItem->Text = L"Відкрити";
			this->відкритиToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::відкритиToolStripMenuItem_Click);
			// 
			// зберегтиToolStripMenuItem
			// 
			this->зберегтиToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"зберегтиToolStripMenuItem.Image")));
			this->зберегтиToolStripMenuItem->Name = L"зберегтиToolStripMenuItem";
			this->зберегтиToolStripMenuItem->Size = System::Drawing::Size(156, 22);
			this->зберегтиToolStripMenuItem->Text = L"Зберегти як";
			this->зберегтиToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::зберегтиToolStripMenuItem_Click);
			// 
			// toolStripSeparator2
			// 
			this->toolStripSeparator2->Name = L"toolStripSeparator2";
			this->toolStripSeparator2->Size = System::Drawing::Size(153, 6);
			// 
			// налаштуванняToolStripMenuItem
			// 
			this->налаштуванняToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"налаштуванняToolStripMenuItem.Image")));
			this->налаштуванняToolStripMenuItem->Name = L"налаштуванняToolStripMenuItem";
			this->налаштуванняToolStripMenuItem->Size = System::Drawing::Size(156, 22);
			this->налаштуванняToolStripMenuItem->Text = L"Налаштування";
			this->налаштуванняToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::налаштуванняToolStripMenuItem_Click);
			// 
			// toolStripSeparator1
			// 
			this->toolStripSeparator1->Name = L"toolStripSeparator1";
			this->toolStripSeparator1->Size = System::Drawing::Size(153, 6);
			// 
			// вихідToolStripMenuItem
			// 
			this->вихідToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"вихідToolStripMenuItem.Image")));
			this->вихідToolStripMenuItem->Name = L"вихідToolStripMenuItem";
			this->вихідToolStripMenuItem->Size = System::Drawing::Size(156, 22);
			this->вихідToolStripMenuItem->Text = L"Вихід";
			this->вихідToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::вихідToolStripMenuItem_Click);
			// 
			// функціїToolStripMenuItem
			// 
			this->функціїToolStripMenuItem->DropDownItems->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(2) {this->перегToolStripMenuItem, 
				this->витягнутToolStripMenuItem});
			this->функціїToolStripMenuItem->Name = L"функціїToolStripMenuItem";
			this->функціїToolStripMenuItem->ShowShortcutKeys = false;
			this->функціїToolStripMenuItem->Size = System::Drawing::Size(60, 20);
			this->функціїToolStripMenuItem->Text = L"Функції";
			// 
			// перегToolStripMenuItem
			// 
			this->перегToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"перегToolStripMenuItem.Image")));
			this->перегToolStripMenuItem->Name = L"перегToolStripMenuItem";
			this->перегToolStripMenuItem->Size = System::Drawing::Size(145, 22);
			this->перегToolStripMenuItem->Text = L"Переглянути";
			this->перегToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::перегToolStripMenuItem_Click);
			// 
			// витягнутToolStripMenuItem
			// 
			this->витягнутToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"витягнутToolStripMenuItem.Image")));
			this->витягнутToolStripMenuItem->Name = L"витягнутToolStripMenuItem";
			this->витягнутToolStripMenuItem->ShowShortcutKeys = false;
			this->витягнутToolStripMenuItem->Size = System::Drawing::Size(145, 22);
			this->витягнутToolStripMenuItem->Text = L"Витягнути";
			this->витягнутToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::витягнутToolStripMenuItem_Click);
			// 
			// інформаціяToolStripMenuItem
			// 
			this->інформаціяToolStripMenuItem->DropDownItems->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(2) {this->проПрограмуToolStripMenuItem, 
				this->допомогаToolStripMenuItem});
			this->інформаціяToolStripMenuItem->Name = L"інформаціяToolStripMenuItem";
			this->інформаціяToolStripMenuItem->Size = System::Drawing::Size(83, 20);
			this->інформаціяToolStripMenuItem->Text = L"Інформація";
			// 
			// проПрограмуToolStripMenuItem
			// 
			this->проПрограмуToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"проПрограмуToolStripMenuItem.Image")));
			this->проПрограмуToolStripMenuItem->Name = L"проПрограмуToolStripMenuItem";
			this->проПрограмуToolStripMenuItem->Size = System::Drawing::Size(154, 22);
			this->проПрограмуToolStripMenuItem->Text = L"Про програму";
			this->проПрограмуToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::проПрограмуToolStripMenuItem_Click);
			// 
			// допомогаToolStripMenuItem
			// 
			this->допомогаToolStripMenuItem->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"допомогаToolStripMenuItem.Image")));
			this->допомогаToolStripMenuItem->Name = L"допомогаToolStripMenuItem";
			this->допомогаToolStripMenuItem->ShortcutKeys = System::Windows::Forms::Keys::F1;
			this->допомогаToolStripMenuItem->Size = System::Drawing::Size(154, 22);
			this->допомогаToolStripMenuItem->Text = L"Допомога";
			this->допомогаToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::допомогаToolStripMenuItem_Click);
			// 
			// statusStrip1
			// 
			this->statusStrip1->Items->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(2) {this->toolStripProgressBar1, 
				this->toolStripStatusLabel1});
			this->statusStrip1->Location = System::Drawing::Point(0, 239);
			this->statusStrip1->Name = L"statusStrip1";
			this->statusStrip1->Size = System::Drawing::Size(284, 22);
			this->statusStrip1->TabIndex = 2;
			this->statusStrip1->Text = L"statusStrip1";
			// 
			// toolStripProgressBar1
			// 
			this->toolStripProgressBar1->Name = L"toolStripProgressBar1";
			this->toolStripProgressBar1->Size = System::Drawing::Size(100, 16);
			// 
			// toolStripStatusLabel1
			// 
			this->toolStripStatusLabel1->Name = L"toolStripStatusLabel1";
			this->toolStripStatusLabel1->Size = System::Drawing::Size(92, 17);
			this->toolStripStatusLabel1->Text = L"Стан пристрою";
			// 
			// button1
			// 
			this->button1->Anchor = static_cast<System::Windows::Forms::AnchorStyles>((System::Windows::Forms::AnchorStyles::Bottom | System::Windows::Forms::AnchorStyles::Left));
			this->button1->Location = System::Drawing::Point(13, 205);
			this->button1->Name = L"button1";
			this->button1->Size = System::Drawing::Size(82, 23);
			this->button1->TabIndex = 3;
			this->button1->Text = L"Переглянути";
			this->button1->UseVisualStyleBackColor = true;
			this->button1->Click += gcnew System::EventHandler(this, &MyForm::button1_Click);
			// 
			// button2
			// 
			this->button2->Anchor = static_cast<System::Windows::Forms::AnchorStyles>((System::Windows::Forms::AnchorStyles::Bottom | System::Windows::Forms::AnchorStyles::Right));
			this->button2->Location = System::Drawing::Point(193, 205);
			this->button2->Name = L"button2";
			this->button2->Size = System::Drawing::Size(79, 23);
			this->button2->TabIndex = 4;
			this->button2->Text = L"Витягти";
			this->button2->UseVisualStyleBackColor = true;
			this->button2->Click += gcnew System::EventHandler(this, &MyForm::button2_Click);
			// 
			// toolStrip1
			// 
			this->toolStrip1->ImageScalingSize = System::Drawing::Size(24, 24);
			this->toolStrip1->Items->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(7) {this->toolStripButton1, 
				this->toolStripButton2, this->toolStripButton4, this->toolStripButton5, this->toolStripButton6, this->toolStripButton7, this->toolStripButton8});
			this->toolStrip1->Location = System::Drawing::Point(0, 24);
			this->toolStrip1->Name = L"toolStrip1";
			this->toolStrip1->Size = System::Drawing::Size(284, 31);
			this->toolStrip1->TabIndex = 5;
			this->toolStrip1->Text = L"toolStrip1";
			// 
			// toolStripButton1
			// 
			this->toolStripButton1->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton1->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton1.Image")));
			this->toolStripButton1->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton1->Name = L"toolStripButton1";
			this->toolStripButton1->Size = System::Drawing::Size(28, 28);
			this->toolStripButton1->Text = L"toolStripButton1";
			this->toolStripButton1->ToolTipText = L"Відкрити";
			this->toolStripButton1->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton1_Click);
			// 
			// toolStripButton2
			// 
			this->toolStripButton2->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton2->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton2.Image")));
			this->toolStripButton2->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton2->Name = L"toolStripButton2";
			this->toolStripButton2->Size = System::Drawing::Size(28, 28);
			this->toolStripButton2->Text = L"toolStripButton2";
			this->toolStripButton2->ToolTipText = L"Зберегти як";
			this->toolStripButton2->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton2_Click);
			// 
			// toolStripButton4
			// 
			this->toolStripButton4->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton4->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton4.Image")));
			this->toolStripButton4->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton4->Name = L"toolStripButton4";
			this->toolStripButton4->Size = System::Drawing::Size(28, 28);
			this->toolStripButton4->Text = L"toolStripButton4";
			this->toolStripButton4->ToolTipText = L"Налаштування";
			this->toolStripButton4->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton4_Click);
			// 
			// toolStripButton5
			// 
			this->toolStripButton5->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton5->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton5.Image")));
			this->toolStripButton5->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton5->Name = L"toolStripButton5";
			this->toolStripButton5->Size = System::Drawing::Size(28, 28);
			this->toolStripButton5->Text = L"toolStripButton5";
			this->toolStripButton5->ToolTipText = L"Переглянути";
			this->toolStripButton5->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton5_Click);
			// 
			// toolStripButton6
			// 
			this->toolStripButton6->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton6->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton6.Image")));
			this->toolStripButton6->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton6->Name = L"toolStripButton6";
			this->toolStripButton6->Size = System::Drawing::Size(28, 28);
			this->toolStripButton6->Text = L"toolStripButton6";
			this->toolStripButton6->ToolTipText = L"Витягти";
			this->toolStripButton6->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton6_Click);
			// 
			// toolStripButton7
			// 
			this->toolStripButton7->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton7->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton7.Image")));
			this->toolStripButton7->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton7->Name = L"toolStripButton7";
			this->toolStripButton7->Size = System::Drawing::Size(28, 28);
			this->toolStripButton7->Text = L"toolStripButton7";
			this->toolStripButton7->ToolTipText = L"Про програму";
			this->toolStripButton7->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton7_Click);
			// 
			// toolStripButton8
			// 
			this->toolStripButton8->DisplayStyle = System::Windows::Forms::ToolStripItemDisplayStyle::Image;
			this->toolStripButton8->Image = (cli::safe_cast<System::Drawing::Image^  >(resources->GetObject(L"toolStripButton8.Image")));
			this->toolStripButton8->ImageTransparentColor = System::Drawing::Color::Magenta;
			this->toolStripButton8->Name = L"toolStripButton8";
			this->toolStripButton8->Size = System::Drawing::Size(28, 28);
			this->toolStripButton8->Text = L"toolStripButton8";
			this->toolStripButton8->ToolTipText = L"Допомога";
			this->toolStripButton8->Click += gcnew System::EventHandler(this, &MyForm::toolStripButton8_Click);
			// 
			// openFileDialog1
			// 
			this->openFileDialog1->FileName = L"openFileDialog1";
			// 
			// timer1
			// 
			this->timer1->Tick += gcnew System::EventHandler(this, &MyForm::timer1_Tick);
			// 
			// notifyIcon1
			// 
			this->notifyIcon1->ContextMenuStrip = this->contextMenuStrip1;
			this->notifyIcon1->Icon = (cli::safe_cast<System::Drawing::Icon^  >(resources->GetObject(L"notifyIcon1.Icon")));
			this->notifyIcon1->Text = L"USB Commander";
			this->notifyIcon1->Visible = true;
			this->notifyIcon1->MouseDoubleClick += gcnew System::Windows::Forms::MouseEventHandler(this, &MyForm::notifyIcon1_MouseDoubleClick);
			// 
			// contextMenuStrip1
			// 
			this->contextMenuStrip1->Items->AddRange(gcnew cli::array< System::Windows::Forms::ToolStripItem^  >(2) {this->розгорнутиToolStripMenuItem, 
				this->вихідToolStripMenuItem2});
			this->contextMenuStrip1->Name = L"contextMenuStrip1";
			this->contextMenuStrip1->Size = System::Drawing::Size(138, 48);
			// 
			// розгорнутиToolStripMenuItem
			// 
			this->розгорнутиToolStripMenuItem->Name = L"розгорнутиToolStripMenuItem";
			this->розгорнутиToolStripMenuItem->Size = System::Drawing::Size(137, 22);
			this->розгорнутиToolStripMenuItem->Text = L"Розгорнути";
			this->розгорнутиToolStripMenuItem->Click += gcnew System::EventHandler(this, &MyForm::розгорнутиToolStripMenuItem_Click);
			// 
			// вихідToolStripMenuItem2
			// 
			this->вихідToolStripMenuItem2->Name = L"вихідToolStripMenuItem2";
			this->вихідToolStripMenuItem2->Size = System::Drawing::Size(137, 22);
			this->вихідToolStripMenuItem2->Text = L"Вихід";
			this->вихідToolStripMenuItem2->Click += gcnew System::EventHandler(this, &MyForm::вихідToolStripMenuItem2_Click);
			// 
			// timer2
			// 
			this->timer2->Interval = 3000;
			this->timer2->Tick += gcnew System::EventHandler(this, &MyForm::timer2_Tick);
			// 
			// MyForm
			// 
			this->AutoScaleDimensions = System::Drawing::SizeF(6, 13);
			this->AutoScaleMode = System::Windows::Forms::AutoScaleMode::Font;
			this->ClientSize = System::Drawing::Size(284, 261);
			this->Controls->Add(this->toolStrip1);
			this->Controls->Add(this->button2);
			this->Controls->Add(this->button1);
			this->Controls->Add(this->statusStrip1);
			this->Controls->Add(this->listView1);
			this->Controls->Add(this->menuStrip1);
			this->ForeColor = System::Drawing::SystemColors::ControlText;
			this->FormBorderStyle = System::Windows::Forms::FormBorderStyle::FixedSingle;
			this->Icon = (cli::safe_cast<System::Drawing::Icon^  >(resources->GetObject(L"$this.Icon")));
			this->ImeMode = System::Windows::Forms::ImeMode::Disable;
			this->KeyPreview = true;
			this->MainMenuStrip = this->menuStrip1;
			this->MinimumSize = System::Drawing::Size(300, 300);
			this->Name = L"MyForm";
			this->StartPosition = System::Windows::Forms::FormStartPosition::CenterScreen;
			this->Text = L"USB Commander";
			this->FormClosing += gcnew System::Windows::Forms::FormClosingEventHandler(this, &MyForm::MyForm_FormClosing);
			this->Load += gcnew System::EventHandler(this, &MyForm::MyForm_Load);
			this->KeyDown += gcnew System::Windows::Forms::KeyEventHandler(this, &MyForm::MyForm_KeyDown);
			this->Resize += gcnew System::EventHandler(this, &MyForm::MyForm_Resize);
			this->menuStrip1->ResumeLayout(false);
			this->menuStrip1->PerformLayout();
			this->statusStrip1->ResumeLayout(false);
			this->statusStrip1->PerformLayout();
			this->toolStrip1->ResumeLayout(false);
			this->toolStrip1->PerformLayout();
			this->contextMenuStrip1->ResumeLayout(false);
			this->ResumeLayout(false);
			this->PerformLayout();

		}
#pragma endregion
private: System::Void MyForm_Load(System::Object^  sender, System::EventArgs^  e) 
			{

				USB_List = gcnew Dictionary <DWORD, USB_Device^>();
	
				notifyIcon1->Visible = false;
				toolStripProgressBar1->Visible = false;
				toolStripStatusLabel1->Visible = false;

				ProgressBarF("Пошук пристроїв");

				ISUpdating = FALSE;

				Sleep(2000);

				timer1->Start();
				timer2->Start(); 
			}

private: System::Void OpenF(void )
{
	OpenFileDialog^ openFileDialog1 = gcnew OpenFileDialog;

	openFileDialog1->InitialDirectory = "c:\\";
	openFileDialog1->Filter = "txt files (*.txt)|*.txt|All files (*.*)|*.*";
	openFileDialog1->FilterIndex = 2;
	openFileDialog1->RestoreDirectory = true;

	if ( openFileDialog1->ShowDialog() == System::Windows::Forms::DialogResult::OK )
	{
		if ( openFileDialog1->FileName != "" )
		{
			Process^ notepad = gcnew Process();
			ProcessStartInfo^ info = gcnew ProcessStartInfo("notepad.exe", openFileDialog1->FileName);
			try
			{
				notepad->Start(info);
			}
			catch (...)
			{
				return;
			}
		}
	}
}
private: System::Void SaveF(void )
{
	SaveFileDialog^ saveFileDialog1 = gcnew SaveFileDialog;

	saveFileDialog1->InitialDirectory = "c:\\";
	saveFileDialog1->Filter = "txt files (*.txt)|*.txt|All files (*.*)|*.*";
	saveFileDialog1->FilterIndex = 2;
	saveFileDialog1->RestoreDirectory = true;

	if ( saveFileDialog1->ShowDialog() == System::Windows::Forms::DialogResult::OK )
	{
		if ( saveFileDialog1->FileName != "" )
		{
            IO::StreamWriter ^sw;
			try 
			{
				sw = gcnew StreamWriter(saveFileDialog1->FileName);
				sw->WriteLine(DateTime::Now);

				while (ISUpdating)
				{
					Sleep(100);
				}
				ISUpdating = TRUE;
				for each (KeyValuePair<DWORD, USB_Device^> SaverObject in USB_List)
				{
					SaverObject.Value->SaveFile(sw);
				}
			}
			catch(...)
			{
				ISUpdating = FALSE;
				sw->Close();
			}
			ISUpdating = FALSE;
			sw->Close();
		}
	}
}
private: System::Void RemoveFunction()
		{
			 try
			 {
				 while (ISUpdating)
				 {
					Sleep(100);
				 }
				 ISUpdating = TRUE;
				 DWORD RemoveKey[MAX_PATH] = {0};
				 for (int i = 0; i < listView1->SelectedItems->Count; i++)
				 {
					String^ PerName = listView1->SelectedItems[i]->Text;
					String^ sep = ":";
					for (int j = PerName->Length - 1; j >= 0; j--)
						if (PerName[j] == sep[0])
						{
							PerName = Convert::ToString(PerName[j - 1]);
							break;
						}
					 try
					 {
						 for each (KeyValuePair<DWORD, USB_Device^> EjectorObject in USB_List)
						 {
							 if (EjectorObject.Value->GetNameCharFormat() == PerName)
							 {
								 if(EjectorObject.Value->VolumeEject(PerName))
									{
										notifyIcon1->BalloonTipText = "Пристрій " + listView1->SelectedItems[i]->Text + " може бути безпечно витягнутий";
										notifyIcon1->Visible = true;
										notifyIcon1->ShowBalloonTip(2000);
										RemoveKey[i] = EjectorObject.Key;
										listView1->SelectedItems[i]->Remove();
									}
								 else
								 {
									 notifyIcon1->BalloonTipText = "Безпечне витягнення пристрою " + listView1->SelectedItems[i]->Text + " неможливе";
									 notifyIcon1->Visible = true;
									 notifyIcon1->ShowBalloonTip(2000);
								 }
							 }
						 }
					 }
					 catch(...)
					 {
						notifyIcon1->BalloonTipText = "Безпечне витягнення пристрою " + listView1->SelectedItems[i]->Text + " неможливе";
						notifyIcon1->Visible = true;
						notifyIcon1->ShowBalloonTip(2000);
					 }
					 USB_List->Remove(RemoveKey[i]);
				 }
				 ISUpdating = FALSE;
			 }
			 catch(...)
			 {
				ISUpdating = FALSE;
				return;
			 }
		}
private: System::Void ViewFunction()
		{
			while (ISUpdating)
				{
					Sleep(100);
				}
			ISUpdating = TRUE;
			for (int i = 0; i < listView1->SelectedItems->Count; i++)
			 {
				String^ PerName = listView1->SelectedItems[i]->Text;
				String^ sep = ":";
				for (int i = PerName->Length - 1; i >= 0; i--)
					if (PerName[i] == sep[0])
					{
						PerName = Convert::ToString(PerName[i - 1]) + Convert::ToString(PerName[i]);
						break;
					}
				Process^ explorer = gcnew Process();
				ProcessStartInfo^ info = gcnew ProcessStartInfo("explorer.exe", PerName);
				try
				{
					explorer->Start(info);
				}
				catch(...)
				{
				}
			 } 
			ISUpdating = FALSE;
		}
private: System::Void ProgressBarF(String ^h)
		{
			toolStripProgressBar1->Visible = true;
			toolStripStatusLabel1->Visible = true;
			toolStripStatusLabel1->Text = h;
			toolStripProgressBar1->Value = toolStripProgressBar1->Minimum;
		}

private: System::Void вихідToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Вихід з програми"); 
			 for each(KeyValuePair<DWORD, USB_Device^> CloseObject in USB_List)
			 {
					CloseObject.Value->Close();
			 }
			 Application::Exit();
		 }
private: System::Void вихідToolStripMenuItem2_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 for each(KeyValuePair<DWORD, USB_Device^> CloseObject in USB_List)
			 {
				CloseObject.Value->Close();
			 }
			 Application::Exit();
		 }
private: System::Void MyForm_FormClosing(System::Object^  sender, System::Windows::Forms::FormClosingEventArgs^  e) 
		 {
			for each(KeyValuePair<DWORD, USB_Device^> CloseObject in USB_List)
			{
				CloseObject.Value->Close();
			}
		 }


private: System::Void налаштуванняToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Kursova::SettingsForm1 ^SetngForm = gcnew SettingsForm1(USB_List, ISUpdating);
			 timer1->Start();
			 ProgressBarF("Налаштування"); 
			 SetngForm->ShowDialog();
		 }
private: System::Void toolStripButton4_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Kursova::SettingsForm1 ^SetngForm = gcnew SettingsForm1(USB_List, ISUpdating);
			 timer1->Start();
			 ProgressBarF("Налаштування"); 
			 SetngForm->ShowDialog();
		 }
private: System::Void вихідToolStripMenuItem1_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Kursova::SettingsForm1 ^SetngForm = gcnew SettingsForm1(USB_List, ISUpdating);
			 SetngForm->ShowDialog();
		 }


private: System::Void проПрограмуToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Kursova::AboutForm1 ^AbForm = gcnew AboutForm1;
			 timer1->Start();
			 ProgressBarF("Про програму"); 
			 AbForm->ShowDialog();
		 }
private: System::Void toolStripButton7_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Kursova::AboutForm1 ^AbForm = gcnew AboutForm1;
			 timer1->Start();
			 ProgressBarF("Про програму"); 
			 AbForm->ShowDialog();
		 }


private: System::Void відкритиToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Відкриття файлу");  
			 OpenF();
		 }
private: System::Void toolStripButton1_Click(System::Object^  sender, System::EventArgs^  e) 
		 {			  
			 timer1->Start();
			 ProgressBarF("Відкриття файлу"); 
			 OpenF();
		 }



private: System::Void зберегтиToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Збереження даних");
			 SaveF();
		 }
private: System::Void toolStripButton2_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Збереження даних");
			 SaveF();
		 }


private: System::Void button1_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Перегляд пристрою");
			 ViewFunction();
		 }
private: System::Void toolStripButton5_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Перегляд пристрою");
			 ViewFunction();
		 }
private: System::Void перегToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Перегляд пристрою");
			 ViewFunction();
		 }

private: System::Void button2_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Витягнення пристрою");
			 RemoveFunction();
		 }
private: System::Void toolStripButton6_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Витягнення пристрою"); 
			 RemoveFunction();
		 }
private: System::Void витягнутToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 timer1->Start();
			 ProgressBarF("Витягнення пристрою"); 
			 RemoveFunction();
		 }


private: void timer1_Tick(System::Object^  sender, System::EventArgs^  e) 
		 {

			if ( toolStripProgressBar1->Value != toolStripProgressBar1->Maximum)
			{
				if(toolStripStatusLabel1->Text == "Пошук пристроїв")
					toolStripProgressBar1->Increment(5);
				else 
					toolStripProgressBar1->Increment(50);
			}	
			else 
			{
				if (toolStripStatusLabel1->Text == "Пошук пристроїв")
					timer1->Stop();
				else 
				{
					toolStripProgressBar1->Visible = false;
					toolStripStatusLabel1->Visible = false;
					timer1->Stop();
				}
			}
		 }

private: System::Void notifyIcon1_MouseDoubleClick(System::Object^  sender, System::Windows::Forms::MouseEventArgs^  e) 
		 {
			this->Show();
            notifyIcon1->Visible = false;
			WindowState = FormWindowState::Normal;
		 }
	
private: System::Void MyForm_Resize(System::Object^  sender, System::EventArgs^  e) 
		 {
			 if (WindowState == FormWindowState::Minimized)
			 {
				this->Hide();
				notifyIcon1->Visible = true;
			 }
			 else if (WindowState == FormWindowState::Maximized)
			 {
				 listView1->Columns[0]->Width = 128; 
				 listView1->Columns[1]->Width = 128;
				 listView1->Columns[2]->Width = 128; 
				 listView1->Columns[3]->Width = 128;
				 listView1->Columns[4]->Width = 128; 
				 listView1->Columns[5]->Width = 178;
			 }
			 else if (WindowState == FormWindowState::Normal)
			 {
				 listView1->Columns[0]->Width = 128; 
				 listView1->Columns[1]->Width = 128;
				 listView1->Columns[2]->Width = 0; 
				 listView1->Columns[3]->Width = 0;
				 listView1->Columns[4]->Width = 0; 
				 listView1->Columns[5]->Width = 0;
			 }
		 }
private: System::Void розгорнутиToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 if (WindowState == FormWindowState::Minimized)
			 {
				this->Show();
				notifyIcon1->Visible = false;
				WindowState = FormWindowState::Normal;
			 }
		 }

private: System::Void ParseMultiStrings( IN LPCTSTR szString, OUT std::vector< LPCTSTR > &vStrings, IN TCHAR chDelim)
{
    LPCTSTR sz = szString;
	chDelim = CHAR( '\0');
    for( ;
        szString && *szString || ( chDelim == CHAR( '\0') && *szString == chDelim && *( szString + 1) != chDelim);
        szString++
        )
    {
        if( *szString == chDelim)
        {
            vStrings.push_back( sz);
            sz = NULL;
        }
        else if( !sz) sz = szString;
    }
    if( sz) vStrings.push_back( sz);
}

private: System::Void MyForm_KeyDown(System::Object^  sender, System::Windows::Forms::KeyEventArgs^  e) 
		 {
			  while (ISUpdating)
				{
					Sleep(100);
				}
			  try
			  {
				  ISUpdating = TRUE;
				  DWORD RemoveKey[MAX_PATH] = {0};
				  int p = 0;
				  int q = 0;
				  for each (KeyValuePair<DWORD, USB_Device^> EjectorObject in USB_List)
					{
						 int k = EjectorObject.Value->GetHotKey();
						 if(e->Control && e->KeyValue == k)
						 {
							 try
							 {
								 for (q = 0; q < listView1->Items->Count; q++)
								 {
									String^ PerName = listView1->Items[q]->Text;
									String^ sep = ":";
									for (int i = PerName->Length - 1; i >= 0; i--)
									{	
										if (PerName[i] == sep[0])
										{
											PerName = Convert::ToString(PerName[i - 1]);
											break;
										}
									}
									if (PerName == EjectorObject.Value->GetNameCharFormat())
										break;
								 }
								if(EjectorObject.Value->VolumeEject(EjectorObject.Value->GetNameCharFormat()))
								{
									notifyIcon1->BalloonTipText = "Пристрій " + listView1->Items[q]->Text + " може бути безпечно витягнутий";
									notifyIcon1->Visible = true;
									notifyIcon1->ShowBalloonTip(2000);
									RemoveKey[p++] = EjectorObject.Key;
									listView1->Items[q]->Remove();
								}
								else
								{
									notifyIcon1->BalloonTipText = "Безпечне витягнення пристрою " + listView1->Items[q]->Text + " неможливе";
									notifyIcon1->Visible = true;
									notifyIcon1->ShowBalloonTip(2000);
								}
							 }
							 catch(...)
							 {
								notifyIcon1->BalloonTipText = "Безпечне витягнення пристрою " + listView1->Items[q]->Text + " неможливе";
								notifyIcon1->Visible = true;
								notifyIcon1->ShowBalloonTip(2000);
							 }
						 }
					 }
				  for (int i = 0; i < p; i++)
					 USB_List->Remove(RemoveKey[i]);
				  ISUpdating = FALSE;
			  }
			  catch(...)
			  {
				ISUpdating = FALSE;
			  }
		 }


private: System::Void timer2_Tick(System::Object^  sender, System::EventArgs^  e) 
		 {
				while (ISUpdating)
				{
					Sleep(100);
				}
				ISUpdating = TRUE;
				
				try
				{
					for each(KeyValuePair<DWORD, USB_Device^> CloseObject in USB_List)
					{
						CloseObject.Value->Close();
					}
				
					USB_List->Clear();

					System::Char szDrives[256] = {0};
					std::vector< LPCTSTR > vDrives;
					std::vector< LPCTSTR>::iterator it;
					String^ DriveStr;
					std::wstring DrS;
					HANDLE hDevice; 
				

					if (GetLogicalDriveStrings( sizeof(szDrives), szDrives ) )
					{					
						ParseMultiStrings( szDrives, vDrives, '\0');
						for (unsigned int i = 0; i < vDrives.size(); i++)
						{	
							if(GetDriveType(vDrives[i]) == DRIVE_REMOVABLE)
							{

								try
								{
									DrS = L"\\\\.\\";
									DrS += vDrives[i][0];
									DrS += vDrives[i][1];

									hDevice = CreateFile(DrS.c_str(), GENERIC_READ|GENERIC_WRITE, FILE_SHARE_READ|FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL);
									if (hDevice != INVALID_HANDLE_VALUE)
									{
								
										DriveStr = "";
										for (int j = 0; vDrives[i][j] != ':'; j++)
											DriveStr += Convert::ToString(vDrives[i][j]);
								
										wchar_t NameBuffer[MAX_PATH] = {0};
										wchar_t SysNameBuffer[MAX_PATH] = {0};
										wchar_t Namr[MAX_PATH] = {0};
										DWORD VSNumber;
										DWORD MCLength;
										DWORD FileSF;

										GetVolumeInformationByHandleW(hDevice, NameBuffer, 256, &VSNumber, &MCLength, &FileSF, SysNameBuffer, sizeof(SysNameBuffer));
								
										unsigned long long FreeAvSize;
										unsigned long long TotalSize;
										unsigned long long FreeSize;
										GetDiskFreeSpaceEx(vDrives[i], (PULARGE_INTEGER)&FreeAvSize, (PULARGE_INTEGER)&TotalSize, (PULARGE_INTEGER)&FreeSize);
										FreeAvSize  = (FreeAvSize / 1024) / 1024;
										TotalSize  = (TotalSize / 1024) / 1024;
										FreeSize  = (FreeSize / 1024) / 1024;
								
										String^ SysName = "";
										for (int j = 0; SysNameBuffer[j] != '\0'; j++)
											SysName += Convert::ToString(SysNameBuffer[j]);
										String^ Dev_Name = "";
										for (int j = 0; NameBuffer[j] != '\0'; j++)
											Dev_Name += Convert::ToString(NameBuffer[j]);
										if (Dev_Name == "")
											Dev_Name = "Знімний диск";

										CHAR HK = '\0';

										if (SysName == "RAW" || USB_List->ContainsKey(VSNumber))
										{
											CloseHandle(hDevice);
										}
										else 
										{	
											USB_List->Add(VSNumber, %USB_Device(vDrives[i], DrS.c_str(), DriveStr, hDevice, Dev_Name, SysName, VSNumber, MCLength, HK, FreeAvSize, TotalSize));
										}
									}
								}
								catch(Exception^ error)
								{
									ISUpdating = FALSE;
									throw gcnew Exception(error->Message);
								}
							}
						}
					}
					ISUpdating = FALSE;
					UpdateHotKeyLog();
					UpdateMainList();
					toolStripProgressBar1->Visible = false;
					toolStripStatusLabel1->Visible = false;
				}
				catch(...)
				{
					toolStripProgressBar1->Visible = false;
					toolStripStatusLabel1->Visible = false;
					ISUpdating = FALSE;
				}
		 }
public: System::Void UpdateHotKeyLog()
		{
			IO::StreamWriter ^cw;
			try
			{
				cw = gcnew StreamWriter(Application::StartupPath + "\\HotKeyLog.hkl", true);
			}
			catch(...)
			{
				cw->Close();
				ISUpdating = FALSE;
				return;
			}
			cw->Close();
			IO::StreamReader ^sr;
			try 
			{
				sr = gcnew StreamReader(Application::StartupPath + "\\HotKeyLog.hkl");
				UpdatingList = gcnew Dictionary<DWORD, CHAR>();
				String^ Line = "";
				using namespace Runtime::InteropServices;
				char* charLine;
				CHAR HK = '\0';
				DWORD Number = 0;
				const int k = 10;	//	Lenth of Serial Number of Volume 
			
				while (!sr->EndOfStream)
				{
					CHAR HK = '\0';
					DWORD Number = 0;
					Line = sr->ReadLine();
					if (Line->Length > 10)
					{
						charLine = (char*)(Marshal::StringToHGlobalAnsi(Line)).ToPointer();
						HK = charLine[strlen(charLine) - 1]; 
						if (HK == ' ')
							HK = '\0';
						for (int i = k - 1; i >= 0; i--)
						{
							Number += (charLine[i] - '0')*(DWORD)Math::Pow(10, k - 1 - i);
						}
						if (Number > 0 && !UpdatingList->ContainsKey(Number))
							UpdatingList->Add(Number, HK);
					}
				}
			}
			catch(...)
			{
				sr->Close();
				ISUpdating = FALSE;
				return;
			}
			sr->Close();
			for each(KeyValuePair<DWORD, USB_Device^> ^UpdatingObject in USB_List)
			{
				try
				{
					if (UpdatingList->ContainsKey(UpdatingObject->Key) && UpdatingObject->Value->GetHotKeyWChar() != L'\0')
					{	
						UpdatingList->Remove(UpdatingObject->Key);
						UpdatingList->Add(UpdatingObject->Key, UpdatingObject->Value->GetHotKeyWChar());
					}
					else if (!UpdatingList->ContainsKey(UpdatingObject->Key))
					{
						UpdatingList->Add(UpdatingObject->Value->GetSerialNumber(), UpdatingObject->Value->GetHotKeyWChar());
					}
					else if (UpdatingList->ContainsKey(UpdatingObject->Key) && UpdatingObject->Value->GetHotKeyWChar() == L'\0')
					{
						String^ HS = "";
						HS += Convert::ToString(WCHAR(UpdatingList[UpdatingObject->Key]));
						UpdatingObject->Value->SetHotKey(HS);
					}
				}
				catch(...)
				{
					continue;
				}
			}
			IO::StreamWriter ^sw;
			try
			{
				sw = gcnew StreamWriter(Application::StartupPath + "\\HotKeyLog.hkl");
				for each(KeyValuePair<DWORD, CHAR> ^UpdatingObject in UpdatingList)
				{
					String^ HS = "";
					HS += Convert::ToString(WCHAR(UpdatingObject->Value));
					sw->WriteLine(UpdatingObject->Key + " " + HS);
				}
			}
			catch(...)
			{
				sw->Close();
				ISUpdating = FALSE;
				return;
			}
			sw->Close();
			ISUpdating = FALSE;
		}

private: System::Void UpdateMainList()
		 {
			 unsigned int TotalSize = 0;
			 unsigned int FreeSize = 0;
			 unsigned int SerialNumber = 0;
			 String^ Dev_Name = "";
			 String^ Sys_Name = "";
			 WCHAR HotKey = L'\0';
			 List<String^> ^DeleteList = gcnew List<String^>();
			 BOOL NeedLoad = TRUE;

			 for each(KeyValuePair<DWORD, USB_Device^> ^UpdatingObject in USB_List)
			 {

				Dev_Name = UpdatingObject->Value->GetNameListForm();
				TotalSize = UpdatingObject->Value->GetTotalSize();
				FreeSize = UpdatingObject->Value->GetFreeSize();
				Sys_Name = UpdatingObject->Value->GetSysName();
				SerialNumber = (unsigned int)UpdatingObject->Value->GetSerialNumber();
				HotKey = UpdatingObject->Value->GetHotKeyWChar();
				NeedLoad = TRUE;

				for (int i = 0; i < listView1->Items->Count; i++)
				{
					if (Dev_Name == listView1->Items[i]->Text)
					{
						NeedLoad = FALSE;
						if (HotKey != L'\0')
							listView1->Items[i]->SubItems[5]->Text = Convert::ToString("Ctrl + " + HotKey);
					}
				}

				if (NeedLoad)
				{
					try
					{
						listView1->Items->Add(Dev_Name);
						
						if (TotalSize / 1024 >= 10)
							listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString(TotalSize/1024) + " GB");
						else if (TotalSize > 1024)
							listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString( (TotalSize/1024) + "," + ((TotalSize*1000/1024)%1000)/10 + " GB"));
						else 
							listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString(TotalSize) + " MB");

						if (FreeSize / 1024 >= 10)
							listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString(FreeSize/1024) + " GB");
						else if (FreeSize > 1024)
							listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString( (FreeSize/1024) + "," + ((FreeSize*1000/1024)%1000)/10 + " GB"));
						else 
							listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString(FreeSize) + " MB");

						listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Sys_Name);

						listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString(SerialNumber));
						if (HotKey != L'\0')
						listView1->Items[listView1->Items->Count - 1]->SubItems->Add(Convert::ToString("Ctrl + " + HotKey));
						else listView1->Items[listView1->Items->Count - 1]->SubItems->Add("");
					}
					catch(...)
					{
						continue;
					}

				}

				DeleteList->Add(Dev_Name);
			 }
			 for (int i = 0; i < listView1->Items->Count; i++)
			 {
				 if (!DeleteList->Contains(listView1->Items[i]->Text))
					 listView1->Items[i]->Remove();
			 }
		 }

private: System::Void toolStripButton8_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Help::ShowHelp(this, Application::StartupPath + "\\USB_Commander(Helper).chm");
		 }
private: System::Void допомогаToolStripMenuItem_Click(System::Object^  sender, System::EventArgs^  e) 
		 {
			 Help::ShowHelp(this, Application::StartupPath + "\\USB_Commander(Helper).chm");
		 }
};

}
